<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>GainGrid Hosted — Ads Player</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- EXACT Google AdSense core script (kept) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2309008538670900"
     crossorigin="anonymous"></script>

<style>
  :root{
    --accent1:#ff6b9d; --accent2:#c471ed;
    --bg:linear-gradient(135deg,#0f1419 0,#1a2332 50%,#0d1117 100%);
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;color:#fff;background:var(--bg)}
  .viewport-wrap{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;padding:12px}
  .card{width:var(--card-width,420px);height:var(--card-height,520px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.5);display:flex;flex-direction:column;overflow:hidden}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex:0 0 auto}
  .back-btn{background:transparent;border:0;color:rgba(255,255,255,0.9);cursor:pointer;font-weight:700}
  h2{margin:0;font-size:16px}
  .small{font-size:12px;color:rgba(255,255,255,0.78)}
  .btn{padding:8px 10px;border-radius:8px;background:linear-gradient(45deg,var(--accent1),var(--accent2));border:none;color:#fff;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .content{flex:1 1 auto;overflow:hidden;display:flex;flex-direction:column}
  .ad-player{width:100%;height:var(--ad-height,320px);border-radius:8px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;position:relative;margin-top:12px}
  .ad-player iframe,.ad-player video{width:100%;height:100%;border:0;object-fit:cover}
  .note{margin-top:8px;color:rgba(255,255,255,0.6);font-size:12px}
  .countdown{font-weight:700;font-size:18px;color:#fff}
  .hidden{display:none}
  #adPlayerAdsenseHolder, #adsterBannerHolder{display:flex;justify-content:center;align-items:center}
  .dbg{position:absolute;left:8px;bottom:8px;padding:6px 8px;background:rgba(0,0,0,0.6);border-radius:6px;font-size:11px;color:#fff;z-index:50;display:none}
  .dbg.dbg-visible{display:block}
  .controls{display:flex;gap:8px;margin-top:10px;justify-content:center;align-items:center}
  .muted-note{font-size:11px;color:rgba(255,255,255,0.5);text-align:center;margin-top:6px}
  .disabled{opacity:0.45;pointer-events:none}
</style>
</head>
<body>
  <div class="viewport-wrap">
    <div class="card" id="root">
      <div class="topbar">
        <button id="backBtn" class="back-btn">← Close</button>
        <div style="text-align:right">
          <div class="small" id="vipInfo">VIP: —</div>
        </div>
      </div>

      <div class="content">
        <div id="main" class="small">Initializing…</div>

        <!-- ad player container -->
        <div class="ad-player" id="adPlayer">
          <div id="adPlaceholder" class="small" style="color:#999;">Ad player area</div>
        </div>

        <div class="controls" id="controls" aria-hidden="true" style="margin-top:12px">
          <div id="countWrap" style="display:flex;align-items:center;gap:10px">
            <div class="small">Time left:</div>
            <div class="countdown" id="adCount">--</div>
          </div>

          <button id="claimBtn" class="btn" disabled>Claim</button>
          <button id="skipBtn" class="btn ghost hidden">Skip</button>
          <button id="backToBtn" class="btn ghost hidden">Back</button>
        </div>

        <div id="adsterBannerHolder" style="margin-top:12px"></div>
        <div id="adPlayerAdsenseHolder" style="margin-top:8px"></div>

        <div class="note" id="noteArea" style="margin-top:8px"></div>
        <div class="muted-note" id="mutedNote">Autoplay may be blocked by browser; allow autoplay in iframe or browser settings.</div>
      </div>

      <div class="dbg" id="dbg">dbg</div>
    </div>
  </div>

<script>
/* ============================
   GainGrid HOSTED — Ad-only page
   - Reads hash payload (base64 or URL-encoded JSON)
   - Posts hosted_ready to parent
   - Supports: iframe (gain.web), deeplink (?start=<b64>), standalone
   - Exposes markAdComplete(), closeHosted()
   - Keeps AdSense + Adsterra placeholders
   ============================ */

(function(){
  'use strict';

  /* CONFIG KEYS (kept names) */
  const KEY_AUTH = 'gg_hosted_authoritative_payload';
  const KEY_PROFILE = 'gg_hosted_profile';
  const AD_DURATIONS = [30,40,50,60];

  /* DOM helpers (kept IDs same as your UI) */
  const el = id => document.getElementById(id);
  const main = el('main');
  const adPlayer = el('adPlayer');
  const adPlaceholder = el('adPlaceholder');
  const controls = el('controls');
  const adCountEl = el('adCount');
  const claimBtn = el('claimBtn');
  const skipBtn = el('skipBtn');
  const backToBtn = el('backToBtn');
  const backBtn = el('backBtn');
  const noteArea = el('noteArea');
  const vipInfo = el('vipInfo');
  const dbg = el('dbg');

  /* STATE */
  let MODE = 'standalone'; // 'iframe' | 'deeplink' | 'standalone'
  let authoritativePayload = null;
  let startPayload = null;
  let currentAd = null;
  let adTimer = null;
  let remaining = 0;
  let finished = false;

  /* UTILITIES */
  function log(...s){ try{ console.log('[hosted]', ...s); }catch(e){} }
  function setDbg(t){ if(dbg){ dbg.textContent = t; dbg.classList.add('dbg-visible'); setTimeout(()=> dbg.classList.remove('dbg-visible'), 2200); } }
  function now(){ return Date.now(); }
  function randFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  /* STORAGE helpers */
  function saveAuth(p){ try{ sessionStorage.setItem(KEY_AUTH, JSON.stringify(p)); authoritativePayload = p; }catch(e){} }
  function clearAuth(){ try{ sessionStorage.removeItem(KEY_AUTH); sessionStorage.removeItem(KEY_PROFILE); authoritativePayload = null; }catch(e){} }
  function readAuth(){ try{ return JSON.parse(sessionStorage.getItem(KEY_AUTH)||'null'); }catch(e){ return null; } }

  /* apply VIP/PROFILE UI (keeps name) */
  function applyUserData(u){
    try{
      if(!u) return;
      const vip = (u.vip_level || u.vip) ? (u.vip_level || u.vip) : '—';
      if(vipInfo) vipInfo.textContent = 'VIP: ' + vip;
      try{ sessionStorage.setItem(KEY_PROFILE, JSON.stringify(u)); }catch(e){}
    }catch(e){}
  }

  /* decode helpers: accepts url-encoded JSON or url-safe base64 */
  function tryDecodePayloadString(raw){
    if(!raw) return null;
    try{
      // try url-encoded JSON
      if(raw.startsWith('%7B') || raw.indexOf('%22') !== -1){
        try{ return JSON.parse(decodeURIComponent(raw)); }catch(e){}
      }
      // try base64 (URL-safe)
      let norm = raw.replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
      const pad = norm.length % 4;
      if(pad === 2) norm += '=='; else if(pad === 3) norm += '=';
      try{
        const decoded = atob(norm);
        try{ return JSON.parse(decoded); }catch(e){ return decoded; }
      } catch(e){
        try{ return JSON.parse(raw); }catch(e){ return null; }
      }
    }catch(e){ return null; }
  }

  /* HASH payload reader (gain.web writes base64 into #<payload>) */
  function readHashPayload(){
    try{
      const h = (location.hash || '').replace(/^#/,'');
      if(!h) return null;
      // if looks like path (#/ad?ad_id=...) don't try base64
      if(h.indexOf('=') !== -1 || h.indexOf('&') !== -1 || h.indexOf('?') === 0){
        // handle path-like: "/ad?ad_id=..."
        const parts = h.split('?');
        const path = parts[0].replace(/^\//,'').toLowerCase();
        const qp = {};
        if(parts[1]) parts[1].split('&').forEach(p=>{
          const i = p.indexOf('=');
          if(i>=0) qp[decodeURIComponent(p.slice(0,i))] = decodeURIComponent(p.slice(i+1));
          else qp[decodeURIComponent(p)] = '';
        });
        // return qp with path flag
        return Object.assign({ _path: path }, qp);
      }

      // otherwise try to decode as base64 or raw JSON
      const decoded = tryDecodePayloadString(decodeURIComponent(h));
      return decoded;
    }catch(e){ return null; }
  }

  /* MODE detection: deeplink param or parent iframe presence */
  const QS = (function(){ const s = location.search.replace(/^\?/,''); if(!s) return {}; return s.split('&').filter(Boolean).map(p=>{ const idx=p.indexOf('='); if(idx<0) return [decodeURIComponent(p),'']; const k=decodeURIComponent(p.slice(0,idx)); const v=decodeURIComponent(p.slice(idx+1)); return [k,v]; }).reduce((acc,[k,v])=>{ if(acc[k]===undefined) acc[k]=v; else if(Array.isArray(acc[k])) acc[k].push(v); else acc[k]=[acc[k],v]; return acc; }, {}); })();

  if(QS.start){
    const decoded = tryDecodePayloadString(QS.start);
    if(decoded && typeof decoded === 'object'){
      MODE = 'deeplink';
      startPayload = decoded;
      saveAuth(decoded);
      applyUserData(decoded.payload || decoded.user || decoded);
      setDbg('deeplink payload');
    } else {
      // try base64 raw
      try{
        const padded = QS.start + '='.repeat((4 - QS.start.length%4) % 4);
        const json = atob(padded.replace(/-/g,'+').replace(/_/g,'/'));
        const obj = JSON.parse(json);
        if(obj){ MODE = 'deeplink'; startPayload = obj; saveAuth(obj); applyUserData(obj.payload||obj.user||obj); setDbg('deeplink base64'); }
      }catch(e){}
    }
  }

  if(window.parent && window.parent !== window && MODE !== 'deeplink'){
    MODE = 'iframe';
  }

  /* handshake: read hash payload (priority) then announce ready to parent */
  (function initHandshakeAndPayload(){
    try{
      const h = readHashPayload();
      if(h){
        // if path-style (/_path), build normalized payload
        if(h._path){
          const norm = Object.assign({}, h);
          delete norm._path;
          // support ad query
          if(h._path === 'ad' || h._path === 'adview'){
            const p = {
              ad_id: norm.ad_id || norm.id || null,
              secs: Number(norm.secs || norm.duration || norm.s || 0) || null,
              reward: Number(norm.reward || norm.r || norm.base) || 0,
              user: { user_id: norm.user_id || norm.uid || null },
              meta: { origin: 'hash_path' }
            };
            startPayload = p;
            saveAuth(p);
            applyUserData(p.user || {});
            setDbg('hash path payload');
          } else {
            startPayload = norm;
            saveAuth(norm);
            applyUserData(norm.user || norm.profile || {});
            setDbg('hash path generic');
          }
        } else {
          // base64/json decoded object
          startPayload = h;
          saveAuth(h);
          applyUserData(h.payload || h.user || h);
          setDbg('hash base64/json');
        }
      } else {
        // fallback: if session has KEY_AUTH (parent prewrote), load it
        const stored = readAuth();
        if(stored){ startPayload = stored; applyUserData(stored.user || stored.profile || stored); setDbg('auth from session'); }
      }

      // Announce ready to parent (gain.web). Include ad_id if we know it.
      const readyPayload = { ts: now(), href: location.href };
      if(startPayload && (startPayload.ad_id || startPayload.id || (startPayload.payload && (startPayload.payload.ad_id || startPayload.payload.id)))){
        readyPayload.ad_id = startPayload.ad_id || startPayload.id || (startPayload.payload && (startPayload.payload.ad_id || startPayload.payload.id));
      }
      try { window.parent && window.parent.postMessage({ type: 'hosted_ready', payload: readyPayload }, '*'); }catch(e){}
      setDbg('hosted_ready sent');

    }catch(e){ console.warn('initHandshakeAndPayload err', e); }
  })();

  /* ADSTERRE + ADSENSE injection helpers (kept minimal) */
  function injectAdsterraInto(idOrElem){
    try{
      let holder = null;
      if(typeof idOrElem === 'string') holder = document.getElementById(idOrElem);
      else holder = idOrElem;
      if(!holder) return;
      holder.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.style.width = '468px'; wrap.style.maxWidth='100%'; wrap.style.height='60px'; wrap.style.margin='0 auto';
      const s1 = document.createElement('script'); s1.type='text/javascript';
      s1.text = "atOptions = { 'key' : 'a8702b8b4c48420a3815542007f1c0df', 'format' : 'iframe', 'height' : 60, 'width' : 468, 'params' : {} };";
      wrap.appendChild(s1);
      const s2 = document.createElement('script'); s2.type='text/javascript'; s2.src = "//www.highperformanceformat.com/a8702b8b4c48420a3815542007f1c0df/invoke.js";
      wrap.appendChild(s2);
      holder.appendChild(wrap);
    }catch(e){}
  }
  function injectAdsense(holderId){
    try{
      const holder = document.getElementById(holderId);
      if(!holder) return;
      holder.innerHTML = `<ins class="adsbygoogle" style="display:inline-block;width:320px;height:50px" data-ad-client="ca-pub-2309008538670900" data-ad-slot="4194843603"></ins>`;
      try{ (window.adsbygoogle = window.adsbygoogle || []).push({}); }catch(e){}
    }catch(e){}
  }

  /* UI helpers */
  function resetUI(){
    finished = false;
    if(adTimer) { clearInterval(adTimer); adTimer = null; }
    remaining = 0;
    adCountEl.textContent = '--';
    claimBtn.disabled = true;
    claimBtn.classList.add('disabled');
    claimBtn.classList.remove('hidden');
    skipBtn.classList.add('hidden');
    backToBtn.classList.add('hidden');
    noteArea.textContent = '';
    controls.classList.remove('disabled');
  }

  function enableControlsForMode(mode){
    controls.setAttribute('aria-hidden','false');
    if(mode === 'iframe'){
      claimBtn.disabled = true; claimBtn.classList.add('disabled'); claimBtn.classList.remove('hidden');
      skipBtn.classList.add('hidden');
      backToBtn.classList.add('hidden');
    } else if(mode === 'deeplink'){
      claimBtn.classList.add('hidden');
      skipBtn.classList.remove('hidden'); skipBtn.disabled = false; skipBtn.classList.remove('disabled');
      backToBtn.classList.add('hidden');
    } else {
      // standalone
      claimBtn.disabled = true; claimBtn.classList.add('disabled');
      skipBtn.classList.add('hidden');
      backToBtn.classList.add('hidden');
      controls.classList.add('disabled');
    }
  }

  /* Render video ad (fallback) */
  function renderAdVideo(src){
    try{
      adPlayer.innerHTML = '';
      const video = document.createElement('video');
      video.src = src || 'https://storage.googleapis.com/interactive-media-ads/media/big_buck_bunny_trailer.mp4';
      video.autoplay = true; video.muted = true; video.playsInline = true; video.controls = false;
      video.style.width = '100%'; video.style.height = '100%'; video.style.objectFit = 'cover';
      adPlayer.appendChild(video);
      // attempt to play (some browsers block autoplay)
      video.play().catch(()=>{ /* ignore */ });
      return video;
    }catch(e){ console.warn('renderAdVideo err', e); return null; }
  }

  /* Start ad flow (called by parent via hash/postMessage or by deeplink handling) */
  function startAdFlow(adObj, opts = {}){
    try{
      resetUI();
      currentAd = Object.assign({}, adObj || {});
      // normalize keys
      const ad_id = currentAd.ad_id || currentAd.id || ('host_ad_' + Date.now());
      currentAd.ad_id = ad_id;
      currentAd.secs = Number(currentAd.secs || currentAd.duration || currentAd.s || 0) || null;
      currentAd.reward = Number(currentAd.reward || currentAd.r || currentAd.base) || 0;
      currentAd.vip_level = currentAd.vip_level || currentAd.vip || (startPayload && (startPayload.vip_level||startPayload.vip)) || null;
      currentAd.user = currentAd.user || (startPayload && (startPayload.user || startPayload.payload && startPayload.payload.user)) || null;

      // persist authoritative payload
      clearAuth();
      saveAuth(currentAd);

      // ensure secs: if absent pick random (for deeplink)
      if(!currentAd.secs || currentAd.secs <= 0) currentAd.secs = randFrom(AD_DURATIONS);

      // render ad player (video fallback)
      renderAdVideo(currentAd.video || currentAd.src || null);

      // inject monetization placeholders
      injectAdsterraInto('adsterBannerHolder');
      injectAdsense('adPlayerAdsenseHolder');

      // enable controls based on MODE
      enableControlsForMode(MODE);

      // announce opened to parent / opener for handshake
      try{ window.parent && window.parent.postMessage({ type: 'hosted_opened', payload:{ ad_id: currentAd.ad_id, secs: currentAd.secs, reward: currentAd.reward } }, '*'); }catch(e){}

      // start timer for iframe & deeplink
      if(MODE === 'iframe' || MODE === 'deeplink'){
        remaining = Number(currentAd.secs || 30);
        adCountEl.textContent = remaining;
        adTimer = setInterval(()=>{
          remaining--;
          adCountEl.textContent = remaining;
          if(remaining <= 0){
            clearInterval(adTimer);
            onAdFinished();
          }
        }, 1000);
      } else {
        adCountEl.textContent = '--';
        noteArea.textContent = 'Standalone demo: countdown disabled.';
      }

      // wire claim / skip / back
      claimBtn.onclick = function(){
        if(claimBtn.disabled) return;
        finalizeForParent({ reason: 'claimed_by_user' });
      };
      skipBtn.onclick = function(){
        if(MODE !== 'deeplink') return;
        // send skip to bot/webhook
        finalizeForDeeplink({ skipped: true });
      };
      backToBtn.onclick = function(){
        if(MODE === 'iframe'){
          try{ window.parent && window.parent.postMessage({ type:'close_hosted', payload:{ ad_id: currentAd.ad_id } }, '*'); }catch(e){}
          tryClose();
        } else if(MODE === 'deeplink'){
          finalizeForDeeplink({ navigate_back: true });
        } else {
          tryClose();
        }
      };

      setDbg('ad started ' + ad_id);
    }catch(e){ console.warn('startAdFlow err', e); }
  }

  /* When countdown ends */
  function onAdFinished(){
    if(finished) return;
    finished = true;
    setDbg('ad finished');
    adCountEl.textContent = 0;
    noteArea.textContent = 'Ad finished. Validating...';

    if(MODE === 'iframe'){
      // enable claim, send ad_complete to parent as info (parent may still want manual claim)
      claimBtn.disabled = false; claimBtn.classList.remove('disabled');
      // send ad_complete notice
      try{ window.parent && window.parent.postMessage({ type:'ad_complete', payload: { ad_id: currentAd.ad_id, reward: currentAd.reward, base: currentAd.base||0, vip_level: currentAd.vip_level||null, meta:{ ts: now() } } }, '*'); }catch(e){}
      backToBtn.textContent = 'Back to dash'; backToBtn.classList.remove('hidden');
    } else if(MODE === 'deeplink'){
      skipBtn.classList.add('hidden');
      backToBtn.textContent = 'Back to game'; backToBtn.classList.remove('hidden');
      // finalize by sending to webhook/deeplink/bot
      finalizeForDeeplink({ skipped: false });
    } else {
      noteArea.textContent = 'Ad finished (standalone demo). No validation performed.';
    }
  }

  /* Finalize for parent (iframe) - sends ad_complete & task_complete (compat) */
  function finalizeForParent(opts = {}){
    try{
      const payload = {
        ad_id: currentAd.ad_id,
        reward: currentAd.reward || 0,
        base: currentAd.base || 0,
        vip_bonus: currentAd.vip_bonus || 0,
        vip_level: currentAd.vip_level || null,
        user_id: (currentAd.user && (currentAd.user.user_id || currentAd.user.id)) || null,
        status: (opts.skipped ? 'skipped' : 'completed'),
        meta: { ts: now(), source: 'hosted_iframe' }
      };
      // post to parent
      try{ window.parent && window.parent.postMessage({ type:'ad_complete', payload }, '*'); }catch(e){}
      try{ window.parent && window.parent.postMessage({ type:'task_complete', payload }, '*'); }catch(e){}
      // attempt webhook if authoritative payload includes webhook
      try{
        const auth = readAuth();
        const wh = auth && (auth.webhook || auth.callback || auth.hook || auth.url);
        if(wh){
          fetch(wh, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ action:'ads_validate', payload }), keepalive: true }).catch(()=>{});
        }
      }catch(e){}
      noteArea.textContent = 'Validation sent to parent.';
      backToBtn.textContent = 'Back to dash'; backToBtn.classList.remove('hidden');
    }catch(e){ console.warn('finalizeForParent err', e); }
  }

  /* Finalize for deeplink — tries webhook -> bot_deeplink -> opener postMessage fallback */
  async function finalizeForDeeplink(opts = {}){
    try{
      const sp = startPayload || readAuth();
      const webhook = (sp && (sp.webhook || sp.callback || (sp.payload && sp.payload.webhook))) || null;
      const bot_deeplink = (sp && (sp.bot_deeplink || (sp.payload && sp.payload.bot_deeplink))) || null;
      const game_name = (sp && (sp.payload && sp.payload.game_name)) || sp && sp.game_name || null;
      const user = (sp && (sp.payload && sp.payload.user)) || sp && sp.user || null;

      const result = {
        ad_id: currentAd.ad_id,
        reward: currentAd.reward || 0,
        base: currentAd.base || 0,
        vip_bonus: currentAd.vip_bonus || 0,
        vip_level: currentAd.vip_level || null,
        user_id: (user && (user.user_id || user.id)) || (sp && sp.user_id) || null,
        game_name: game_name || null,
        status: (opts.skipped ? 'skipped' : 'completed'),
        meta: { ts: now(), source: 'hosted_deeplink' }
      };

      if(webhook){
        try{
          await fetch(webhook, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ action:'ads_validate', payload: result }), keepalive: true });
          noteArea.textContent = 'Validation sent to webhook.';
        }catch(e){
          console.warn('webhook POST failed', e);
          noteArea.textContent = 'Webhook send failed.';
        }
      } else if(bot_deeplink){
        try {
          const b = btoa(JSON.stringify({ action:'ads_validate', payload: result })).replace(/=+$/,'');
          const url = bot_deeplink.includes('t.me') ? bot_deeplink + '?start=' + encodeURIComponent(b) : ('https://t.me/' + bot_deeplink + '?start=' + encodeURIComponent(b));
          window.open(url, '_blank');
          noteArea.textContent = 'Validation sent via bot deeplink.';
        } catch(e){ console.warn('bot deeplink failed', e); noteArea.textContent = 'Bot deeplink failed.'; }
      } else {
        try{
          if(window.opener && !window.opener.closed) window.opener.postMessage({ type:'ads_validate', payload: result }, '*');
          noteArea.textContent = 'Validation posted to opener (fallback).';
        }catch(e){ console.warn('opener post failed', e); noteArea.textContent = 'Validation fallback used.'; }
      }

      // close when possible (Telegram WebApp or window.close)
      try{
        if(window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.close === 'function'){
          setTimeout(()=>{ try{ Telegram.WebApp.close(); }catch(e){} }, 900);
        } else {
          setTimeout(()=>{ try{ window.close(); }catch(e){} }, 900);
        }
      }catch(e){}
    }catch(e){ console.warn('finalizeForDeeplink err', e); }
  }

  /* Exposed helpers for parent or console */
  window.markAdComplete = function(meta){
    try{
      // send ad_complete to parent & run deeplink webhook if needed
      const payload = Object.assign({ ad_id: currentAd && currentAd.ad_id || null, meta: Object.assign({ ts: now() }, meta || {}) }, {});
      try{ window.parent && window.parent.postMessage({ type:'ad_complete', payload }, '*'); }catch(e){}
      // if deeplink mode, also call finalizeToDeeplink
      if(MODE === 'deeplink') finalizeForDeeplink({ skipped:false });
    }catch(e){ console.warn('markAdComplete err', e); }
  };

  window.closeHosted = function(){ try{ window.parent && window.parent.postMessage({ type:'close_hosted' }, '*'); }catch(e){} tryClose(); };

  /* try close utility */
  function tryClose(){
    try{
      if(window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.close === 'function'){
        try{ Telegram.WebApp.close(); return; }catch(e){}
      }
      try{ window.close(); }catch(e){}
    }catch(e){}
  }

  /* message listener from parent (gain.web) for postMessage flows */
  window.addEventListener('message', function(ev){
    try{
      const data = ev.data || {};
      if(!data || typeof data !== 'object') return;
      // Accept any origin here to allow your dev environment; in production you may check ev.origin
      // start_payload or open_ad from parent
      if((data.type === 'start_payload' || data.type === 'open_ad') && data.payload){
        // store and start
        clearAuth();
        saveAuth(data.payload);
        startPayload = data.payload;
        applyUserData(startPayload.user || startPayload.profile || startPayload);
        // start ad if payload contains ad info
        const p = data.payload;
        const adObj = {
          ad_id: p.ad_id || p.id || (p.payload && (p.payload.ad_id || p.payload.id)) || ('host_ad_' + Date.now()),
          secs: Number(p.secs || p.duration || (p.payload && p.payload.secs)) || null,
          reward: Number(p.reward || p.base || (p.payload && p.payload.reward)) || 0,
          user: p.user || (p.payload && p.payload.user) || null,
          vip_level: p.vip_level || p.vip || null,
          webhook: p.webhook || (p.payload && p.payload.webhook) || null,
          bot_deeplink: p.bot_deeplink || (p.payload && p.payload.bot_deeplink) || null
        };
        // switch mode to iframe if parent posted it
        MODE = 'iframe';
        setDbg('start_payload via postMessage');
        // start after a tick
        setTimeout(()=> startAdFlow(adObj, { invokedBy: 'parent' }), 80);
        return;
      }

      // parent requesting profile (hosted should reply)
      if(data.type === 'profile_request'){
        const profile = (function(){
          try{ return JSON.parse(sessionStorage.getItem(KEY_PROFILE)||'null'); }catch(e){ return null; }
        })() || (startPayload && (startPayload.user || startPayload.profile)) || null;
        try{ window.parent.postMessage({ type:'profile_response', payload: profile }, '*'); }catch(e){}
        return;
      }

      // parent may instruct to close
      if(data.type === 'request_close' || data.type === 'close_hosted'){
        tryClose();
        return;
      }

    }catch(e){ console.warn('hosted message err', e); }
  }, false);

  /* Auto start behaviour: if startPayload exists and includes ad_id -> auto-run (useful for hash) */
  (function autoStartIfNeeded(){
    try{
      const p = startPayload || readAuth();
      if(p && (p.ad_id || p.id || (p.payload && (p.payload.ad_id || p.payload.id)))){
        // normalize to ad object
        const adObj = {
          ad_id: p.ad_id || p.id || (p.payload && (p.payload.ad_id || p.payload.id)) || ('host_ad_' + Date.now()),
          secs: Number(p.secs || p.duration || (p.payload && p.payload.secs)) || null,
          reward: Number(p.reward || p.base || (p.payload && p.payload.reward)) || 0,
          user: p.user || (p.payload && p.payload.user) || null
        };
        // If deeplink mode, keep it; if iframe mode set above already; if standalone we still start player but in inert mode
        setTimeout(()=> startAdFlow(adObj, { invokedBy: 'auto' }), 150);
      } else {
        // nothing to auto-start; show minimal UI/ads placeholders
        resetUI();
        main.textContent = 'Hosted ad player ready.';
        injectAdsterraInto('adsterBannerHolder');
        injectAdsense('adPlayerAdsenseHolder');
      }
    }catch(e){ console.warn('autoStartIfNeeded err', e); }
  })();

  /* wire top-close button */
  backBtn.addEventListener('click', ()=> {
    tryClose();
  });

  /* expose debug helpers */
  window.__hosted_clear = function(){ clearAuth(); resetUI(); setDbg('cleared'); };
  window.__hosted_start = function(ad){ startAdFlow(ad || { ad_id: 'dbg_' + Date.now(), secs: 30, reward: 0.5 }, { invokedBy:'manual' }); };

})();
</script>
</body>
</html>