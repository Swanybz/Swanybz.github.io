<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>GainGrid Hosted — Ad Player</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2309008538670900" crossorigin="anonymous"></script>

<style>
:root{
  --accent1:#ff6b9d; --accent2:#c471ed;
  --bg:linear-gradient(135deg,#0f1419 0,#1a2332 50%,#0d1117 100%);
  --card-w:420px; --card-h:520px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;color:#fff;background:var(--bg)}
.viewport{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;padding:12px}
.card{width:var(--card-w);height:var(--card-h);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.5);display:flex;flex-direction:column;overflow:hidden}
.top{display:flex;align-items:center;justify-content:space-between}
.back-btn{background:transparent;border:0;color:rgba(255,255,255,0.9);cursor:pointer;font-weight:700}
h2{margin:0;font-size:16px}
.small{font-size:12px;color:rgba(255,255,255,0.78)}
.ad-player{width:100%;height:320px;border-radius:8px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;position:relative;margin-top:12px}
.ad-player video, .ad-player iframe{width:100%;height:100%;border:0;object-fit:cover}
.controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px}
.btn{padding:8px 12px;border-radius:8px;background:linear-gradient(45deg,var(--accent1),var(--accent2));border:none;color:#fff;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.note{margin-top:8px;color:rgba(255,255,255,0.6);font-size:12px;text-align:center}
.countdown{font-weight:700;font-size:18px;color:#fff}
.hidden{display:none}
.adsense-preview{margin-top:12px;display:flex;justify-content:center}
#dbg{position:absolute;left:12px;bottom:12px;padding:6px 8px;background:rgba(0,0,0,0.6);border-radius:6px;font-size:11px;color:#fff;z-index:50}
</style>
</head>
<body>
<div class="viewport">
  <div class="card" id="root">
    <div class="top">
      <button id="btnClose" class="back-btn">✕</button>
      <div style="text-align:right">
        <div class="small" id="vipInfo">VIP: —</div>
      </div>
    </div>

    <div id="mainArea" class="small">
      <div id="adWrap">
        <div class="ad-player" id="adPlayer">
          <div class="small" id="adPlaceholder">Initializing…</div>
        </div>

        <div class="controls" id="controls">
          <div class="countdown" id="countdownEl">--</div>
          <button id="claimBtn" class="btn" disabled>Claim</button>
          <button id="skipBtn" class="btn ghost hidden">Skip</button>
        </div>

        <div class="note" id="adNote">Waiting for connection…</div>

        <div class="adsense-preview" id="adSenseHolder">
          <ins class="adsbygoogle"
               style="display:inline-block;width:320px;height:50px"
               data-ad-client="ca-pub-2309008538670900"
               data-ad-slot="4194843603"></ins>
        </div>
      </div>
    </div>

    <div id="dbg" style="display:none">dbg</div>
  </div>
</div>

<script>
/* GainGrid Hosted — Repaired for full handshake */
const KEY_AUTH='gg_hosted_authoritative_payload';
const KEY_PROFILE='gg_hosted_profile';
const el=id=>document.getElementById(id);
let profile=null,currentAd=null,adTimer=null,remaining=0,sourceType='standalone',isInteractive=false;

function debugShow(t){const d=el('dbg');d.style.display='block';d.textContent=t;console.log('[hosted]',t);}
function setVIPLabel(){try{const p=profile||JSON.parse(sessionStorage.getItem(KEY_PROFILE)||'{}');el('vipInfo').textContent=p.vip_level?('VIP: '+p.vip_level):'VIP: —';}catch{}}

function postParent(msg){try{if(window.parent&&window.parent!==window)window.parent.postMessage(msg,'*');if(window.opener&&!window.opener.closed)window.opener.postMessage(msg,'*');}catch{}}

function announceReady(){postParent({type:'hosted_ready',payload:{ts:Date.now(),ad_id:(currentAd&&currentAd.ad_id)||null}});debugShow('Ready — waiting for payload');}

/* receive data from gain.web */
window.addEventListener('message',ev=>{
  const d=ev.data||{};
  if(d.type==='ping_hosted'){postParent({type:'hosted_pong',payload:{ts:Date.now()}});}
  if(d.type==='start_payload'&&d.payload){sourceType='parent';isInteractive=true;processPayload(d.payload);}
  if(d.type==='open_ad'&&d.payload){sourceType='parent';isInteractive=true;processPayload(d.payload);}
  if(d.type==='open_task'&&d.payload){sourceType='parent';isInteractive=true;processPayload(d.payload);}
  if(d.type==='profile_response'&&d.payload){profile=d.payload;sessionStorage.setItem(KEY_PROFILE,JSON.stringify(profile));setVIPLabel();}
});

/* decode and handle incoming payload */
function processPayload(p){
  if(!p)return;
  try{sessionStorage.setItem(KEY_AUTH,JSON.stringify(p));}catch{}
  if(p.user){profile=p.user;sessionStorage.setItem(KEY_PROFILE,JSON.stringify(profile));setVIPLabel();}
  const id=p.ad_id||p.task_id||p.id||('unit_'+Date.now());
  const secs=Number(p.secs||p.duration||30);
  const reward=Number(p.reward||p.base||0);
  currentAd={ad_id:id,secs:secs,reward:reward,vip_level:p.vip_level||null,type:p.type||'ad'};
  startPlayback(currentAd);
}

/* show player and count down */
function startPlayback(ad){
  const v=el('adPlayer');v.innerHTML='';
  const vid=document.createElement('video');
  vid.src="https://storage.googleapis.com/interactive-media-ads/media/big_buck_bunny_trailer.mp4";
  vid.autoplay=true;vid.muted=true;vid.playsInline=true;
  v.appendChild(vid);vid.play().catch(()=>{});
  el('adNote').textContent='Playing '+ad.ad_id+' — '+ad.secs+'s';
  el('countdownEl').textContent=ad.secs;
  remaining=ad.secs;
  if(adTimer)clearInterval(adTimer);
  adTimer=setInterval(()=>{
    remaining--;
    el('countdownEl').textContent=remaining;
    if(remaining<=0){clearInterval(adTimer);adTimer=null;finishAd();}
  },1000);
}

/* complete & report */
function finishAd(){
  if(!currentAd)return;
  const payload={
    ad_id:currentAd.ad_id,
    reward:currentAd.reward,
    vip_level:currentAd.vip_level,
    user_id:(profile&&profile.user_id)||null,
    status:'completed',ts:Date.now()
  };
  postParent({type:(currentAd.type==='task'?'task_complete':'ad_complete'),payload});
  sessionStorage.removeItem(KEY_AUTH);
  el('adNote').textContent='✅ Completed & sent.';
  el('countdownEl').textContent='✔';
  setTimeout(()=>announceReady(),1000);
  currentAd=null;
}

/* close button */
el('btnClose').onclick=()=>{postParent({type:'close_hosted',reason:'user'});window.close&&window.close();};

/* startup */
window.addEventListener('load',()=>{
  announceReady();
  setVIPLabel();
  const stored=sessionStorage.getItem(KEY_AUTH);
  if(stored){try{const p=JSON.parse(stored);processPayload(p);}catch{}}
  (adsbygoogle=window.adsbygoogle||[]).push({});
});
</script>
</body>
</html>