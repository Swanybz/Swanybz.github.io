<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>GainGrid Hosted — Tasks & Ads</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --grad1:#ff6b9d;--grad2:#c471ed;
  --bg:linear-gradient(135deg,#0f1419 0,#1a2332 50%,#0d1117 100%);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:#fff;font-family:Inter,system-ui}
.main{display:flex;align-items:center;justify-content:center;height:100vh;padding:16px}
.card{width:420px;max-width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);border-radius:16px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,0.5);display:flex;flex-direction:column}
.head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
button{cursor:pointer}
.btn{background:linear-gradient(45deg,var(--grad1),var(--grad2));border:none;color:#fff;padding:8px 12px;border-radius:8px;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1)}
.info{font-size:12px;color:rgba(255,255,255,0.7);margin-top:4px}
.player{flex:1;background:#000;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden;margin-top:8px;position:relative}
.player video,.player iframe{width:100%;height:100%;border:0;object-fit:cover}
.bottom{margin-top:10px;display:flex;justify-content:center;gap:8px;align-items:center}
.countdown{font-size:18px;font-weight:700}
.note{font-size:12px;color:rgba(255,255,255,0.6);text-align:center;margin-top:8px}
</style>
</head>
<body>
<div class="main">
 <div class="card">
   <div class="head">
     <div><b id="taskType">Initializing…</b></div>
     <button class="btn ghost" id="closeBtn">×</button>
   </div>

   <div class="player" id="adPlayer"><div id="loadingTxt">Waiting for Gain.web…</div></div>

   <div class="bottom">
     <div class="countdown" id="timer">--</div>
     <button class="btn" id="claimBtn" disabled>Claim</button>
   </div>

   <div class="note" id="noteTxt">Preparing environment…</div>
 </div>
</div>

<script>
/* GainGrid Hosted — Original handshake repaired */
const PLAYER= document.getElementById('adPlayer');
const NOTE= document.getElementById('noteTxt');
const TIMER= document.getElementById('timer');
const CLAIM= document.getElementById('claimBtn');
const TYPE= document.getElementById('taskType');
let countdown=null, left=0, active=null;

/* === announce ready to Gain.web === */
function announceReady(){
  post({type:'_GG_HOSTED_READY', time:Date.now()});
  NOTE.textContent='Ready for connection…';
}

/* === handle incoming payload === */
function handlePayload(data){
  if(!data)return;
  try{
    const {id,secs,reward,type,vip_level,user_id,from}=data;
    active={id,secs,reward,type,vip_level,user_id};
    sessionStorage.setItem('GG_ACTIVE_PAYLOAD',JSON.stringify(active));
    TYPE.textContent= type==='task' ? 'Task Board' : 'Ad Session';
    NOTE.textContent='Connected ✓';
    startPlay();
  }catch(e){
    NOTE.textContent='Error parsing payload';
  }
}

/* === start playback or display === */
function startPlay(){
  PLAYER.innerHTML='';
  const vid=document.createElement('video');
  vid.src='https://storage.googleapis.com/interactive-media-ads/media/big_buck_bunny_trailer.mp4';
  vid.autoplay=true;vid.muted=true;vid.playsInline=true;
  PLAYER.appendChild(vid);
  left=active.secs||30;
  TIMER.textContent=left;
  if(countdown)clearInterval(countdown);
  countdown=setInterval(()=>{
    left--;TIMER.textContent=left;
    if(left<=0){clearInterval(countdown);finish();}
  },1000);
  NOTE.textContent='Playing '+active.id+' ('+left+'s)';
}

/* === finish and report back === */
function finish(){
  TIMER.textContent='✔';
  NOTE.textContent='Completed successfully';
  CLAIM.disabled=false;
  CLAIM.onclick=()=>{
    post({type:'_GG_HOSTED_DONE', payload:active});
    CLAIM.disabled=true;
    NOTE.textContent='Reported back ✓';
    sessionStorage.removeItem('GG_ACTIVE_PAYLOAD');
    setTimeout(()=>announceReady(),1200);
  };
}

/* === bridge post === */
function post(obj){
  try{
    if(window.parent && window.parent!==window) window.parent.postMessage(obj,'*');
    if(window.opener && !window.opener.closed) window.opener.postMessage(obj,'*');
  }catch(e){console.warn(e);}
}

/* === listen from gain.web === */
window.addEventListener('message',e=>{
  const d=e.data||{};
  if(d.type==='_GG_START_PAYLOAD'){handlePayload(d.payload);}
  if(d.type==='_GG_PING'){post({type:'_GG_PONG',time:Date.now()});}
});

/* === restore if payload exists === */
window.addEventListener('load',()=>{
  announceReady();
  const st=sessionStorage.getItem('GG_ACTIVE_PAYLOAD');
  if(st){try{handlePayload(JSON.parse(st));}catch{}}
});

/* === close === */
document.getElementById('closeBtn').onclick=()=>{post({type:'_GG_CLOSE'});window.close&&window.close();};
</script>
</body>
</html>