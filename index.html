<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>GainGrid Hosted — Ads (iframe-ready)</title>

<!-- AdSense core (kept) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2309008538670900"
     crossorigin="anonymous"></script>

<style>
  :root{
    --accent1:#ff6b9d; --accent2:#c471ed;
    --bg:linear-gradient(135deg,#0f1419 0,#1a2332 50%,#0d1117 100%);
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;color:#fff;background:var(--bg)}
  .viewport-wrap{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;padding:12px}
  .card{width:var(--card-width,720px);height:var(--card-height,520px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.5);display:flex;flex-direction:column;overflow:hidden}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex:0 0 auto}
  h2{margin:0;font-size:16px}
  .small{font-size:12px;color:rgba(255,255,255,0.78)}
  .ad-player{width:100%;height:var(--ad-height,360px);border-radius:8px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;position:relative}
  .ad-player iframe, .ad-player video{width:100%;height:100%;border:0;object-fit:cover}
  .controls{margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:center}
  .btn{padding:8px 10px;border-radius:8px;background:linear-gradient(45deg,var(--accent1),var(--accent2));border:none;color:#fff;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .countdown{font-weight:700;font-size:18px;color:#fff}
  .note{margin-top:8px;color:rgba(255,255,255,0.6);font-size:12px;text-align:center}
  .hidden{display:none}
  #dbg{position:absolute;right:10px;bottom:10px;padding:6px 8px;background:rgba(0,0,0,0.6);border-radius:6px;font-size:11px;color:#fff;z-index:50;display:none}
</style>
</head>
<body>
  <div class="viewport-wrap">
    <div class="card" id="root">
      <div class="topbar">
        <div class="small">Hosted view</div>
        <div style="text-align:right">
          <div class="small" id="vipInfo">VIP: —</div>
        </div>
      </div>

      <div class="content" style="flex:1 1 auto;display:flex;flex-direction:column">
        <div id="adPlayer" class="ad-player" aria-live="polite">
          <div id="adPlaceholder" class="small">Ad player area</div>
        </div>

        <!-- Controls: hidden in public mode, visible only for deeplink payload -->
        <div id="controls" class="controls hidden" role="region" aria-label="Ad controls">
          <div class="countdown" id="countdown">—</div>
          <button id="claimBtn" class="btn" disabled>Claim / Send Result</button>
        </div>

        <div class="note" id="note" aria-hidden="false">Waiting for deeplink or public visit...</div>
      </div>

      <div id="dbg">dbg</div>
    </div>
  </div>

<script>
/* =========================
  Hosted HTML — dual-mode:
  - PUBLIC: show ad area only (AdSense -> custom provider iframe -> Adsterra -> fallback video)
  - DEEPLINK/HASH: authoritative payload, show countdown & claim, send results to BOT_WEBHOOK
  ========================= */

/* ===== CONFIG (edit only if needed) ===== */
const BOT_WEBHOOK = "https://gaingrid.bots.business/onWebhook"; // onWebhook receiver
const HOSTED_SESSION_KEY = 'gg_hosted_authoritative_payload';
const ADSTER_SCRIPT_KEY = 'a8702b8b4c48420a3815542007f1c0df';
const ADSTER_SCRIPT_SRC = "//www.highperformanceformat.com/" + ADSTER_SCRIPT_KEY + "/invoke.js";

// your custom provider URL (as provided)
const CUSTOM_PROVIDER_URL = "https://experiencedbat.com/dbm/F.zudZGMN/vBZ_GeUM/Jelm/9ruAZ/UjlGkpPiTuYT2/ORDok/w/NEjDU-t/Ntj/Y/4_OhTuAb2iNQixZWs/aKWn1rpydHDr0IxU";

/* ===== utilities (kept names) ===== */
const el = id => document.getElementById(id);
function dbg(msg){ try{ el('dbg').style.display='block'; el('dbg').textContent = String(msg).slice(0,120); console.log('hosted:', msg); }catch(e){} }
function nowISO(){ return (new Date()).toISOString(); }
function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function safeParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }

/* ===== decode helpers ===== */
function decodeBase64UrlSafe(raw){
  if(!raw) return null;
  try{
    let r = raw.replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
    const pad = r.length % 4;
    if(pad === 2) r += '=='; else if(pad === 3) r += '=';
    const dec = atob(r);
    try{ return JSON.parse(dec); }catch(e){ return dec; }
  }catch(e){ return null; }
}
function tryDecodePayloadString(raw){
  if(!raw) return null;
  try{
    // url-encoded JSON
    if(raw.indexOf('%7B') === 0 || raw.indexOf('%5B') === 0 || raw.indexOf('%22') !== -1){
      try { return JSON.parse(decodeURIComponent(raw)); } catch(e){}
    }
    // raw JSON
    if(raw[0] === '{' || raw[0] === '['){
      try { return JSON.parse(raw); } catch(e){}
    }
    // try base64
    const maybe = decodeBase64UrlSafe(raw);
    if(maybe) return maybe;
    try{ return JSON.parse(decodeURIComponent(raw)); }catch(e){}
  }catch(e){}
  return null;
}

/* ===== ad provider injection helpers ===== */
async function injectAdsense(holder){
  try{
    holder.innerHTML = '';
    const ins = document.createElement('ins');
    ins.className = 'adsbygoogle';
    ins.style.display = 'block';
    ins.style.width = '100%';
    ins.style.height = '100%';
    ins.setAttribute('data-ad-client', 'ca-pub-2309008538670900');
    ins.setAttribute('data-ad-slot', '4194843603');
    holder.appendChild(ins);
    try{ (adsbygoogle = window.adsbygoogle || []).push({}); }catch(e){}
    return true;
  }catch(e){ return false; }
}
function injectCustomProvider(holder){
  try{
    holder.innerHTML = '';
    const ifr = document.createElement('iframe');
    ifr.src = CUSTOM_PROVIDER_URL;
    ifr.style.border = '0';
    ifr.style.width = '100%';
    ifr.style.height = '100%';
    ifr.setAttribute('referrerpolicy','no-referrer');
    holder.appendChild(ifr);
    return true;
  }catch(e){ return false; }
}
function injectAdsterra(holder){
  try{
    holder.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.style.width = '100%'; wrap.style.height = '100%'; wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.justifyContent='center';
    holder.appendChild(wrap);
    const s1 = document.createElement('script'); s1.type='text/javascript';
    s1.text = "atOptions = { 'key' : '" + ADSTER_SCRIPT_KEY + "', 'format' : 'iframe', 'height' : 60, 'width' : 468, 'params' : {} };";
    const s2 = document.createElement('script'); s2.type='text/javascript'; s2.src = ADSTER_SCRIPT_SRC;
    wrap.appendChild(s1); wrap.appendChild(s2);
    return true;
  }catch(e){ return false; }
}
function showFallbackVideo(holder){
  try{
    holder.innerHTML = '';
    const v = document.createElement('video');
    v.src = "https://storage.googleapis.com/interactive-media-ads/media/big_buck_bunny_trailer.mp4";
    v.autoplay = true; v.muted = true; v.playsInline = true; v.controls = false;
    v.style.width='100%'; v.style.height='100%';
    holder.appendChild(v);
    try{ v.play().catch(()=>{}); }catch(e){}
    return true;
  }catch(e){ return false; }
}

/* ===== core: start countdown & POST to webhook (deeplink mode only) ===== */
let countdownTimer = null;
function startCountdownAndReport(authoritativePayload){
  try{
    if(!authoritativePayload || typeof authoritativePayload !== 'object') return;
    // store authoritative copy
    try{ sessionStorage.setItem(HOSTED_SESSION_KEY, JSON.stringify(authoritativePayload)); }catch(e){}
    // determine secs
    const DURS = [30,40,50,60];
    const secs = Number(authoritativePayload.secs) || randChoice(DURS);
    const ad_id = authoritativePayload.ad_id || authoritativePayload.id || ('host_ad_' + Date.now());
    const reward = authoritativePayload.reward || authoritativePayload.r || authoritativePayload.base || 0;

    // show controls
    el('controls').classList.remove('hidden');
    el('note').textContent = `Ad: ${ad_id} — running ${secs}s`;
    el('countdown').textContent = secs;
    el('claimBtn').disabled = true;

    // ensure ad provider visible (prefer AdSense -> custom -> adsterra -> video)
    (async ()=>{
      const holder = el('adPlayer');
      let ok = await injectAdsense(holder);
      if(!ok) ok = injectCustomProvider(holder);
      if(!ok) ok = injectAdsterra(holder);
      if(!ok) showFallbackVideo(holder);
    })();

    // countdown
    let remaining = secs;
    if(countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      remaining--;
      el('countdown').textContent = remaining;
      if(remaining <= 0){
        clearInterval(countdownTimer);
        el('claimBtn').disabled = false;
        el('note').textContent = 'Countdown finished — result posted to webhook.';
        // prepare result payload
        const result = {
          ad_id: ad_id,
          reward: reward,
          base: authoritativePayload.base || 0,
          vip_level: authoritativePayload.vip_level || authoritativePayload.vip || null,
          user: authoritativePayload.user || authoritativePayload.user_id || null,
          status: 'completed',
          ts: nowISO(),
          original_payload: authoritativePayload
        };
        sendToWebhook(result);
      }
    }, 1000);

    // manual claim
    el('claimBtn').onclick = function(){
      el('claimBtn').disabled = true;
      const result = {
        ad_id: ad_id,
        reward: reward,
        base: authoritativePayload.base || 0,
        vip_level: authoritativePayload.vip_level || authoritativePayload.vip || null,
        user: authoritativePayload.user || authoritativePayload.user_id || null,
        status: 'claimed_manual',
        ts: nowISO(),
        original_payload: authoritativePayload
      };
      sendToWebhook(result);
    };

  }catch(e){ console.warn('startCountdownAndReport err', e); dbg('count err'); }
}

/* ===== send to onWebhook (keepalive) ===== */
function sendToWebhook(data){
  try{
    const wrapper = { action: 'ads_validate', payload: data, meta: { ts: Date.now(), host: location.href } };
    const body = JSON.stringify(wrapper);
    let sent = false;
    try{
      if(navigator.sendBeacon){
        const blob = new Blob([body], { type: 'application/json' });
        sent = navigator.sendBeacon(BOT_WEBHOOK, blob);
      }
    }catch(e){ sent = false; }
    if(!sent){
      fetch(BOT_WEBHOOK, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: body, keepalive:true })
        .then(()=>{}).catch(()=>{});
    }
    dbg('webhook sent');
    el('note').textContent = 'Result posted to webhook.';
    // do not close the page automatically (gain.web or bot will close the iframe if needed)
  }catch(e){ console.warn('sendToWebhook err', e); dbg('webhook err'); el('note').textContent = 'Failed to post result'; }
}

/* ===== decode incoming payloads (query start / hash / hash path) ===== */
function getQueryParams(){
  const s = location.search.replace(/^\?/,''); if(!s) return {};
  return s.split('&').filter(Boolean).map(p=>{ const i=p.indexOf('='); if(i<0) return [decodeURIComponent(p),'']; return [decodeURIComponent(p.slice(0,i)), decodeURIComponent(p.slice(i+1))]; }).reduce((o,[k,v])=>{ o[k]=v; return o; }, {});
}

function boot(){
  try{
    // 1) query ?start=
    const qp = getQueryParams();
    if(qp.start){
      const decoded = tryDecodePayloadString(qp.start);
      if(decoded && typeof decoded === 'object'){
        el('note').textContent = 'Deeplink payload received.';
        startCountdownAndReport(decoded);
        return;
      }
    }

    // 2) hash-based
    const h = (location.hash || '').replace(/^#/,'');
    if(h){
      // path-like: #/ad?ad_id=...
      if(h.startsWith('/')){
        const parts = h.split('?'); const path = parts[0].replace(/^\//,'');
        const hashQP = {};
        if(parts[1]) parts[1].split('&').forEach(p=>{ const i=p.indexOf('='); if(i>=0) hashQP[decodeURIComponent(p.slice(0,i))]=decodeURIComponent(p.slice(i+1)); else hashQP[decodeURIComponent(p)]= ''; });
        if(path === 'ad' && (hashQP.ad_id || hashQP.id)){
          const payload = { ad_id: hashQP.ad_id || hashQP.id, secs: hashQP.secs || hashQP.duration, reward: hashQP.reward || hashQP.base, user: { user_id: hashQP.user_id || hashQP.uid || null } };
          el('note').textContent = 'Hash path payload received.';
          startCountdownAndReport(payload);
          return;
        }
      } else {
        const decoded = tryDecodePayloadString(decodeURIComponent(h));
        if(decoded && typeof decoded === 'object'){
          el('note').textContent = 'Hash base64 payload received.';
          startCountdownAndReport(decoded);
          return;
        }
      }
    }

    // no authoritative payload => PUBLIC MODE
    el('note').textContent = 'Public mode — ad area (no controls).';
    el('controls').classList.add('hidden');
    // show ad area: prefer AdSense -> custom provider -> Adsterra -> fallback video
    (async ()=>{
      const holder = el('adPlayer');
      let ok = await injectAdsense(holder);
      if(!ok) ok = injectCustomProvider(holder);
      if(!ok) ok = injectAdsterra(holder);
      if(!ok) showFallbackVideo(holder);
    })();

  }catch(e){ console.warn('boot err', e); dbg('boot err'); }
}

/* run */
boot();

</script>
</body>
</html>