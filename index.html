<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>GainGrid Hosted — Tasks & Ads (iframe-ready)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- EXACT Google AdSense core script (kept) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2309008538670900"
     crossorigin="anonymous"></script>

<style>
  :root{
    --accent1:#ff6b9d; --accent2:#c471ed;
    --bg:linear-gradient(135deg,#0f1419 0,#1a2332 50%,#0d1117 100%);
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;color:#fff;background:var(--bg)}
  .viewport-wrap{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;padding:12px}
  .card{width:var(--card-width,420px);height:var(--card-height,620px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.5);display:flex;flex-direction:column;overflow:hidden}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex:0 0 auto}
  .back-btn{background:transparent;border:0;color:rgba(255,255,255,0.9);cursor:pointer;font-weight:700}
  h2{margin:0;font-size:16px}
  .small{font-size:12px;color:rgba(255,255,255,0.78)}
  .btn{padding:8px 10px;border-radius:8px;background:linear-gradient(45deg,var(--accent1),var(--accent2));border:none;color:#fff;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .content{flex:1 1 auto;overflow:hidden;display:flex;flex-direction:column}
  .task-list{display:flex;flex-direction:column;gap:10px;margin:8px 0;overflow:auto;padding-right:6px}
  .task-list::-webkit-scrollbar{width:8px}
  .task-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.05);border-radius:6px}
  .card-item{width:100%;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:56px;}
  .card-item .left{flex:1;min-width:0}
  .card-item strong{display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:14px}
  .card-item .meta{font-size:12px;color:rgba(255,255,255,0.66);margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .ad-player{width:100%;height:var(--ad-height,260px);border-radius:8px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;position:relative;margin-top:12px}
  .ad-player iframe,.ad-player video{width:100%;height:100%;border:0;object-fit:cover}
  .note{margin-top:8px;color:rgba(255,255,255,0.6);font-size:12px}
  .countdown{font-weight:700;font-size:18px;color:#fff}
  .hidden{display:none}
  #adPlayerAdsenseHolder, #taskBanner, #adsterBannerHolder{display:flex;justify-content:center;align-items:center}
  .dbg{position:absolute;left:8px;bottom:8px;padding:6px 8px;background:rgba(0,0,0,0.6);border-radius:6px;font-size:11px;color:#fff;z-index:50;display:none}
  .dbg.dbg-visible{display:block}
  .landing-buttons{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;margin-top:8px}
  .landing-buttons .big{padding:12px 16px;font-size:15px;border-radius:10px}
  .gaingrid-verified{color:lightgreen;margin-top:6px;font-weight:600;font-size:12px}
</style>
</head>
<body>
  <div class="viewport-wrap">
    <div class="card" id="root">
      <div class="topbar">
        <button id="backBtn" class="back-btn">← Back</button>
        <div style="text-align:right">
          <div class="small" id="vipInfo">VIP: —</div>
        </div>
      </div>

      <div class="content">
        <div id="main" class="small">Initializing…</div>
      </div>

      <div class="dbg" id="dbg">dbg</div>
    </div>
  </div>

<script>
/* ============================
   HOSTED HTML — Unified (public + gain.web + deeplink)
   Key behaviors added/kept:
    - Accepts payload via: postMessage {type:'start_payload', payload:{}}
      AND via hash base64 (iframe.src = HOSTED_BASE + '#<base64>')
      AND via query param ?start=<base64>
    - Stores authoritative payload in sessionStorage ('gg_hosted_authoritative_payload')
    - Exposes handshake 'hosted_ready' to parent (includes ad_id if known)
    - Renders public landing (two buttons) when no payload
    - When ad/task payload present, runs ad/task flow and sends back ad_complete / task_complete
   ============================ */

/* ===== EARLY QUEUE & FLAGS ===== */
window.__HOSTED_INCOMING_QUEUE = window.__HOSTED_INCOMING_QUEUE || [];
window.__HOSTED_IS_READY = false;

/* ===== CONFIG & KEYS ===== */
const KEY_AUTH = 'gg_hosted_authoritative_payload';
const KEY_PROFILE = 'gg_hosted_profile';
const ADSENSE_CLIENT = "ca-pub-2309008538670900";
const AD_DURATIONS = [30,40,50,60];

/* ===== small utilities ===== */
const el = id => document.getElementById(id);
function nowDay(){ return new Date().toISOString().slice(0,10); }
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function setMain(html){ if(el('main')) el('main').innerHTML = html; }
function setVIPLabel(){ const p = profile || (JSON.parse(sessionStorage.getItem(KEY_PROFILE)||'null')||{}); const vip = p && (p.vip_level||p.vip) ? (p.vip_level||p.vip) : ''; if(el('vipInfo')) el('vipInfo').textContent = vip ? ('VIP: ' + vip) : 'VIP: —'; }

/* ===== debug overlay ===== */
(function hostedReadyAndDebug(){
  try{
    if(!document.getElementById('hostedDbg')){
      const dbg = document.createElement('div'); dbg.id = 'hostedDbg';
      dbg.style.position='absolute'; dbg.style.right='10px'; dbg.style.bottom='10px'; dbg.style.zIndex='9999';
      dbg.style.padding='6px 8px'; dbg.style.background='rgba(0,0,0,0.6)'; dbg.style.color='#fff'; dbg.style.fontSize='12px';
      dbg.style.borderRadius='6px'; dbg.style.pointerEvents='none'; dbg.textContent='hosted:init';
      document.body.appendChild(dbg);
    }
    window.__hostedDebug = function(msg){ try{ const d=document.getElementById('hostedDbg'); if(d) d.textContent = 'hosted:' + (msg||'').toString().slice(0,28); console.log('hostedDbg:', msg);}catch(e){} };
  }catch(e){}
})();

/* ===== profile holder ===== */
let profile = null;
function readLocalProfile(){
  try{
    const raw = sessionStorage.getItem(KEY_PROFILE) || localStorage.getItem('profile') || localStorage.getItem('user_data') || localStorage.getItem('gg_user');
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function applyUserData(u){
  try {
    if(!u) return;
    profile = Object.assign({}, profile || {}, u);
    try{ sessionStorage.setItem(KEY_PROFILE, JSON.stringify(profile)); }catch(e){}
    if(el('vipInfo')) el('vipInfo').textContent = profile.vip_level ? ('VIP: ' + profile.vip_level) : (profile.vip ? ('VIP: ' + profile.vip) : 'VIP: —');
  } catch(e){ console.warn('applyUserData', e); }
}

/* ===== decode helpers (base64/hash/URL-JSON) ===== */
function tryDecodePayloadString(raw){
  if(!raw) return null;
  try {
    // try URL-encoded JSON first
    if(raw.startsWith('%7B') || raw.startsWith('%5B') || raw.indexOf('%22')!==-1){
      try{ return JSON.parse(decodeURIComponent(raw)); }catch(e){}
    }
    // normalize URL-safe base64
    let norm = raw.replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
    const pad = norm.length % 4;
    if(pad === 2) norm += '=='; else if(pad === 3) norm += '=';
    try {
      const decoded = atob(norm);
      try{ return JSON.parse(decoded); }catch(e){ return decoded; }
    } catch(e){
      try{ return JSON.parse(raw); }catch(e){ return null; }
    }
  } catch(err){ console.warn('tryDecodePayloadString err', err); return null; }
}

/* ===== central payload processing ===== */
function processStartPayload(payload){
  try {
    if(!payload || typeof payload !== 'object') return;
    // Save authoritative payload
    try{ sessionStorage.setItem(KEY_AUTH, JSON.stringify(payload)); }catch(e){}
    // apply profile if provided (so UI shows correct VIP)
    if(payload.user && typeof payload.user === 'object') applyUserData(payload.user);
    else if(payload.profile && typeof payload.profile === 'object') applyUserData(payload.profile);
    else if(payload.vip_level && (!profile || !profile.vip_level)){ profile = profile || {}; profile.vip_level = payload.vip_level; setVIPLabel(); }

    // route to tasks if provided
    if(Array.isArray(payload.tasks) && payload.tasks.length){
      const mapped = payload.tasks.map(t => ({
        id: t.id || t.task_id || ('task_' + Math.random().toString(36).slice(2,8)),
        title: t.title || t.name || ('Task ' + (t.id||'')),
        secs: t.secs || t.duration || 30,
        reward: t.reward || t.base || 0,
        url: t.url || t.link || '',
        tag: t.tag || t.type || ''
      }));
      PARENT_TASKS = mapped;
      renderTasksFromParent(PARENT_TASKS);
      return;
    }

    // route to ad flow if ad payload present
    if(payload.ad_id || payload.id || payload.type === 'ad' || payload.isAd){
      const ad = {
        ad_id: payload.ad_id || payload.id,
        secs: Number(payload.secs || payload.s || payload.duration) || null,
        reward: Number(payload.reward || payload.r || payload.base) || null,
        vip_level: payload.vip_level || payload.vip || null,
        user: payload.user || payload
      };
      try{ sessionStorage.setItem('gg_hosted_last_ad_payload', JSON.stringify(ad)); }catch(e){}
      // render ad flow
      renderAdFlow({ ad_id: ad.ad_id, secs: ad.secs, reward: ad.reward, vip: ad.vip_level, user: ad.user });
      return;
    }

    // otherwise show a stored state message
    setMain('<div class="small">Payload stored. Use UI to start ad/task.</div>');
  } catch(err){ console.warn('processStartPayload err', err); }
}

/* ===== parse hash payload on boot (support base64 payload in hash) ===== */
(function parseHashPayloadOnBoot(){
  try {
    const h = (location.hash || '').replace(/^#/,'');
    if(!h) return;
    // ignore query-like hash (#/?a=b)
    if(h.indexOf('=') !== -1 || h.indexOf('&') !== -1 || h.indexOf('?') === 0) return;
    const decoded = tryDecodePayloadString(decodeURIComponent(h));
    if(decoded && typeof decoded === 'object'){
      processStartPayload(decoded);
    } else {
      // also support path-like hashes: #/ad?id=... & #/task?...
      const parts = h.split('?');
      const path = parts[0].replace(/^\//,'').toLowerCase();
      const qp = {};
      if(parts[1]){
        parts[1].split('&').forEach(p=>{
          const i = p.indexOf('=');
          if(i>=0) qp[decodeURIComponent(p.slice(0,i))] = decodeURIComponent(p.slice(i+1));
          else qp[decodeURIComponent(p)] = '';
        });
      }
      if(path === 'ad' && (qp.ad_id || qp.id)){
        renderAdFlow({ ad_id: qp.ad_id || qp.id, secs: qp.secs || qp.s || qp.duration, reward: qp.reward || qp.r || qp.base, vip: qp.vip || qp.vip_level, user: null });
      } else if(path === 'task' && (qp.task_id || qp.id)){
        awaitRunTaskFlowFromPayload({ task_id: qp.task_id || qp.id, secs: qp.secs || qp.duration, reward: qp.reward || qp.base, url: qp.url || qp.link });
      }
    }
  } catch(e){ console.warn('parseHashPayloadOnBoot', e); }
})();

/* ===== queue messages that arrive before ready ===== */
window.addEventListener('message', function __earlyHostQueue(ev){
  try{
    const d = ev && ev.data;
    if(!d || typeof d !== 'object') return;

    if(d.type === 'ping_hosted'){
      try{ (ev.source && ev.source.postMessage) && ev.source.postMessage({ type: 'hosted_pong', payload:{ ts: Date.now() } }, '*'); }catch(e){}
      return;
    }

    if(d.type === 'start_payload' || d.type === 'open_task' || d.type === 'open_ad'){
      let normalized = { type:'start_payload', payload: {} };
      if(d.type === 'start_payload'){ normalized = d; } else { normalized.payload = d.payload || d; }
      if(!window.__HOSTED_IS_READY){
        window.__HOSTED_INCOMING_QUEUE.push(normalized);
        return;
      }
      processStartPayload(normalized.payload);
      return;
    }

    if(!window.__HOSTED_IS_READY){
      window.__HOSTED_INCOMING_QUEUE.push(d);
      return;
    }

  }catch(err){ console.warn('earlyHostQueue err', err); }
}, false);

/* helper: notify parent safely (handshake & other messages) */
function postParent(msg){
  try{ if(window.parent && window.parent !== window) window.parent.postMessage(msg, '*'); }catch(e){}
  try{ if(window.opener && !window.opener.closed) window.opener.postMessage(msg, '*'); }catch(e){}
  try{ console.log('postParent:', msg); }catch(e){}
}

/* consume queued messages once ready */
function _consumeQueuedMessages(){
  try{
    while(window.__HOSTED_INCOMING_QUEUE && window.__HOSTED_INCOMING_QUEUE.length){
      const msg = window.__HOSTED_INCOMING_QUEUE.shift();
      if(!msg) continue;
      if(msg.type === 'start_payload') processStartPayload(msg.payload || {});
      else {
        try{ window.dispatchEvent(new MessageEvent('message', { data: msg })); }catch(e){}
      }
    }
  }catch(e){ console.warn('consume queue error', e); }
}

/* ===== announceReady (handshake) ===== */
function announceReady(){
  try{
    window.__HOSTED_IS_READY = true;
    _consumeQueuedMessages();
    // include ad_id if present in stored authoritative payload
    let auth = null;
    try { auth = JSON.parse(sessionStorage.getItem(KEY_AUTH) || 'null'); } catch(e){ auth = null; }
    const payload = { ts: Date.now() };
    if(auth && (auth.ad_id || auth.id)) payload.ad_id = (auth.ad_id || auth.id);
    postParent({ type: 'hosted_ready', payload });
    try{ __hostedDebug && __hostedDebug('ready'); }catch(e){}
    if(el('hostedDbg')) el('hostedDbg').textContent = 'hosted:ready' + (payload.ad_id ? ' ad:' + payload.ad_id : '');
  } catch(e){ console.warn('announceReady failed', e); }
}
if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(announceReady, 60);
else document.addEventListener('DOMContentLoaded', ()=> setTimeout(announceReady, 60));

/* ===== global message handler (main) ===== */
window.addEventListener('message', function(ev){
  try{
    const data = ev.data || {};
    if(!data || typeof data !== 'object') return;
    try{ __hostedDebug && __hostedDebug(data.type || 'msg'); }catch(e){}

    // profile response from parent
    if(data.type === 'profile_response' && data.payload){
      applyUserData(data.payload);
      return;
    }

    // main start payload
    if(data.type === 'start_payload' && data.payload){
      try { processStartPayload(data.payload); } catch(e){ console.warn('processStartPayload msg err', e); }
      return;
    }

    // open a specific ad by parent
    if(data.type === 'open_ad' && data.payload && (data.payload.ad_id || data.payload.id)){
      try{ sessionStorage.setItem(KEY_AUTH, JSON.stringify(data.payload)); }catch(e){}
      renderAdFlow({ ad_id: data.payload.ad_id || data.payload.id, secs: data.payload.secs, reward: data.payload.reward, vip: data.payload.vip, user: data.payload.user });
      return;
    }

    // open a specific task by parent
    if(data.type === 'open_task' && data.payload && (data.payload.task_id || data.payload.id)){
      try{ sessionStorage.setItem(KEY_AUTH, JSON.stringify(data.payload)); }catch(e){}
      awaitRunTaskFlowFromPayload(data.payload);
      return;
    }

    // request close
    if(data.type === 'request_close_from_parent' || data.type === 'request_close'){
      try{ if(window.close) window.close(); }catch(e){} // try to self-close
      return;
    }

  }catch(e){ console.warn('hosted message err', e); }
});

/* ===== PARENT TASKS UI helpers (kept) ===== */
let PARENT_TASKS = null;
function renderTasksFromParent(tasks){
  try{
    PARENT_TASKS = Array.isArray(tasks) ? tasks.slice() : [];
    if(!PARENT_TASKS.length){
      setMain(`<div class="small">No tasks provided by parent.</div>`);
      return;
    }
    const html = PARENT_TASKS.map(t=>{
      const id = t.id || t.task_id || ('task_' + Math.random().toString(36).slice(2,8));
      const title = escapeHtml(t.title || t.name || ('Task ' + id));
      const meta = escapeHtml((t.tag||'') + (t.secs ? (' · stay ' + t.secs + 's') : '') + (t.reward ? (' · Reward ' + t.reward + ' G') : ''));
      const urlEnc = encodeURIComponent(t.url || t.link || '');
      const idEnc = encodeURIComponent(id);
      const secs = Number(t.secs || 30);
      const reward = Number(t.reward || t.base || 0);
      return `<div class="card-item" role="article" data-task-id="${id}">
        <div class="left">
          <strong>${title}</strong>
          <div class="meta">${meta}</div>
        </div>
        <div style="flex-shrink:0">
          <button class="btn do-task" data-id="${idEnc}" data-url="${urlEnc}" data-secs="${secs}" data-reward="${reward}">Do</button>
        </div>
      </div>`;
    }).join('');

    setMain(`<div class="small">Tasks provided by parent (max ${7}/day). Tap a task to start.</div><div class="task-list" id="taskList">${html}</div><div style="margin-top:10px;text-align:center"><div id="taskBanner"></div></div>`);
    injectAdsterraInto('taskBanner');

    // wire buttons (safe)
    Array.from(document.querySelectorAll('.do-task')).forEach(b=> b.replaceWith(b.cloneNode(true)));
    Array.from(document.querySelectorAll('.do-task')).forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = decodeURIComponent(b.getAttribute('data-id'));
        const url = decodeURIComponent(b.getAttribute('data-url'));
        const secs = Number(b.getAttribute('data-secs')||30);
        const rewardBase = Number(b.getAttribute('data-reward')||0);
        postParent({ type:'task_started', payload:{ task_id: id, task_type: 'auto' } });
        await runTaskFlow({ task_id: id, url, secs, rewardBase, reward: rewardBase, _source: 'ui' });
      });
    });
  }catch(e){
    console.warn('renderTasksFromParent error', e);
    setMain(`<div class="small">Unable to render tasks from parent.</div>`);
  }
}

/* ===== router & deeplink handler (keeps public landing) ===== */
function decodeStart(raw){
  if(!raw) return null;
  try{ const norm = raw.replace(/-/g,'+').replace(/_/g,'/'); const json = atob(norm); return JSON.parse(json); }catch(e){ try{ return JSON.parse(decodeURIComponent(raw)); }catch(e){ return null; } }
}
async function router(){
  try{
    const qp = (function(){ const s = location.search.replace(/^\?/,''); const obj={}; if(!s) return obj; s.split('&').filter(Boolean).forEach(p=>{ const i=p.indexOf('='); if(i<0) obj[decodeURIComponent(p)]=''; else obj[decodeURIComponent(p.slice(0,i))]=decodeURIComponent(p.slice(i+1)); }); return obj; })();
    // check start param (deeplink)
    if(qp.start){
      const decoded = decodeStart(qp.start);
      if(decoded){ processStartPayload(decoded); return; }
    }
    // check stored authoritative payload
    const auth = (function(){ try{ return JSON.parse(sessionStorage.getItem(KEY_AUTH)||'null'); }catch(e){return null;} })();
    if(auth){
      if(auth.ad_id) { renderAdFlow(auth); return; }
      if(auth.tasks) { PARENT_TASKS = auth.tasks; renderTasksFromParent(PARENT_TASKS); return; }
    }
    // hash path handling (#/ad or #/task) already handled in parseHashPayloadOnBoot
    showPublicLanding();
  }catch(e){ console.warn('router err', e); showPublicLanding(); }
}

/* ===== Public Landing UI (kept) ===== */
function showPublicLanding(){
  setMain(`
    <div style="text-align:center">
      <h2 style="margin:0 0 6px 0">GainGrid — Public Preview</h2>
      <div class="small">Open demo for AdSense & testers. Choose a section:</div>
      <div class="landing-buttons">
        <button id="landingTasks" class="btn big">🧾 Task Board</button>
        <button id="landingAds" class="btn big">🎥 Ads Center</button>
      </div>
      <div style="margin-top:12px;text-align:center">
        <div id="adPlayerAdsenseHolder" style="margin:8px auto;max-width:468px">
          <!-- Visible AdSense preview (so crawlers see ad slot) -->
          <ins class="adsbygoogle"
               style="display:inline-block;width:468px;height:60px"
               data-ad-client="${ADSENSE_CLIENT}"
               data-ad-slot="4194843603"></ins>
        </div>
        <div class="small" style="margin-top:8px">Ads preview area — GainsGrid public mode</div>
      </div>
    </div>
  `);
  try{ (adsbygoogle = window.adsbygoogle || []).push({}); }catch(e){}
  setTimeout(()=>{
    const lt = el('landingTasks'), la = el('landingAds');
    if(lt) lt.addEventListener('click', ()=> { location.hash = '#/task'; router(); });
    if(la) la.addEventListener('click', ()=> { location.hash = '#/ad'; router(); });
  },40);
}

/* ===== Task flow helpers (kept) ===== */
async function awaitRunTaskFlowFromPayload(p){
  try{
    const id = p.task_id || p.id || ('task_' + Math.random().toString(36).slice(2,8));
    const secs = Number(p.secs || p.duration || 30);
    const reward = Number(p.reward || p.base || 0);
    const url = p.url || p.link || '';
    setTimeout(()=> { try{ runTaskFlow({ task_id: id, url, secs, rewardBase: reward, reward: reward, _source:'ui' }); }catch(e){ console.warn('awaitRunTaskFlowFromPayload err', e); } }, 10);
  }catch(e){ console.warn('awaitRunTaskFlowFromPayload', e); }
}
async function runTaskFlow(opts){
  try{ if(typeof pushView === 'function') pushView('task'); }catch(e){}
  setMain(`<div class="small">Task ${escapeHtml(opts.task_id||'')} — open the target and remain for <strong>${opts.secs||30}s</strong> to verify.</div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center"><button id="openBtn" class="btn">Open & Start</button><button id="cancelBtn" class="btn ghost">Cancel</button></div>
    <div id="taskNote" class="small" style="margin-top:12px"></div>`);
  const openBtn = el('openBtn'), cancelBtn = el('cancelBtn'), note = el('taskNote');
  let finished=false, popup=null, poll=null, expectedEnd=null, safetyTimer=null;

  function cleanup(){
    try{ if(poll) clearInterval(poll); }catch(e){} if(safetyTimer){ clearTimeout(safetyTimer); safetyTimer=null;}
    document.removeEventListener('visibilitychange', visibilityHandler);
    window.removeEventListener('focus', focusHandler);
    window.removeEventListener('message', parentVerificationListener);
  }

  async function finalizeSuccess(){
    if(finished) return;
    finished = true;
    cleanup();
    const vip = (profile && (profile.vip_level || profile.vip)) || null;
    let rewardObj = { base:0, vip_bonus:0, total: opts.reward || opts.rewardBase || 0 };
    addTaskDone(opts.task_id);
    const payload = {
      task_id: opts.task_id,
      reward: rewardObj.total || (opts.reward || 0),
      base: rewardObj.base || 0,
      vip_bonus: rewardObj.vip_bonus || 0,
      vip_level: vip || null,
      user_id: (profile && profile.user_id) || null,
      status: 'completed'
    };
    postParent({ type:'task_complete', payload });
    postParent({ type:'task_verified', payload });
    note.textContent = 'Task verified. Returning...';
    try{ if(typeof saveTaskState === 'function') saveTaskState({ date: nowDay(), status: 'completed' }); }catch(e){}
    try{ if(popup && !popup.closed) popup.close(); }catch(e){}
    try{ clearStartPayload(); }catch(e){}
    setTimeout(()=> { postParent({ type:'close_hosted', reason:'task_done', payload }); try{ if(window.close) window.close(); }catch(e){} }, 700);
  }

  function visibilityHandler(){
    if(document.visibilityState === 'visible' && expectedEnd && Date.now() >= expectedEnd && !finished){
      finalizeSuccess();
    }
  }
  function focusHandler(){
    if(expectedEnd && Date.now() >= expectedEnd && !finished){
      finalizeSuccess();
    }
  }
  function parentVerificationListener(ev){
    try{
      const d = ev.data || {};
      if(d && d.type === 'external_verification' && d.payload && d.payload.task_id === opts.task_id){
        finalizeSuccess();
      }
    }catch(e){}
  }

  openBtn.addEventListener('click', async ()=>{
    cancelBtn.style.display='none';
    openBtn.disabled = true;
    note.textContent = `Opening target — please stay ${opts.secs}s for verification...`;
    expectedEnd = Date.now() + opts.secs*1000;
    try{ popup = window.open(opts.url, '_blank', 'noopener'); }catch(e){ popup = null; }
    if(!popup){
      try{ const a = document.createElement('a'); a.href = opts.url||'#'; a.target='_blank'; a.rel='noopener noreferrer'; a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }catch(e){}
    }
    if(popup){
      poll = setInterval(()=> {
        try{
          if(popup.closed && !finished){
            if(Date.now() < expectedEnd){
              finished = true;
              cleanup();
              const payload = { task_id: opts.task_id, status: 'unverified_popup_closed', reward:0, base:0, vip_bonus:0, user_id: (profile && profile.user_id) || null };
              postParent({ type:'task_complete', payload });
              note.textContent = 'Popup closed before verification. Returning...';
              setTimeout(()=> postParent({ type:'close_hosted', reason:'popup_closed', payload }), 700);
            } else {
              finalizeSuccess();
            }
          }
        }catch(e){}
      },700);
    } else {
      document.addEventListener('visibilitychange', visibilityHandler);
      window.addEventListener('focus', focusHandler);
      window.addEventListener('message', parentVerificationListener);
      safetyTimer = setTimeout(()=> { if(!finished) finalizeSuccess(); }, opts.secs*1000 + 3000);
    }
    setTimeout(()=> { if(!finished) finalizeSuccess(); }, opts.secs*1000 + 8000);
  });

  cancelBtn.addEventListener('click', ()=>{
    postParent({ type:'task_skipped', payload: { task_id: opts.task_id } });
    try{ if(typeof popView === 'function') popView(); }catch(e){}
    try{ if(typeof renderTaskBoard === 'function') renderTaskBoard({}); }catch(e){}
  });

  window.addEventListener('beforeunload', ()=> { if(!finished) postParent({ type:'task_incomplete', payload:{ task_id: opts.task_id } }); });
}

/* ==== Ad flow (core) ==== */
let adTimerInterval = null;
async function renderAdFlow(qp){
  try{
    // combine authoritative payload from sessionStorage with qp param
    const auth = (function(){ try{ return JSON.parse(sessionStorage.getItem(KEY_AUTH) || 'null'); }catch(e){return null;} })();
    const combined = Object.assign({}, auth || {}, qp || {});
    const ad_id = combined.ad_id || combined.id || ('host_ad_' + Date.now());
    const secs = Number(combined.secs) || Number(combined.duration) || randInt(30,60);
    const reward = Number(combined.reward) || Number(combined.r) || (combined.base || 0);
    const vip_level = combined.vip || combined.vip_level || (profile && profile.vip_level) || 'none';
    const user = combined.user || (profile && profile) || null;

    // store last ad payload for debug/parent handshake
    try{ sessionStorage.setItem('gg_hosted_last_ad_payload', JSON.stringify({ ad_id, secs, reward, vip_level, user })); }catch(e){}

    // Render UI
    setMain(`<div class="small">Watching: <strong>${escapeHtml(ad_id)}</strong> — Reward: <strong>${reward} G</strong> <div class="small">(${reward} total)</div></div>
      <div style="margin-top:12px" id="adNode" class="ad-player"><div class="small">Ad player area</div></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center"><div class="countdown" id="adCount">${secs}</div></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center"><button id="claimBtn" class="btn" disabled>Claim</button><button id="retBtn" class="btn ghost hidden">Return</button></div>
      <div class="note" id="adNote">Auto-completes after ${secs}s</div>`);

    // ensure AdSense shows up for crawlers
    try{ (adsbygoogle = window.adsbygoogle || []).push({}); }catch(e){}

    // simple provider injection (video fallback)
    const container = el('adNode');
    const video = document.createElement('video');
    video.src = "https://storage.googleapis.com/interactive-media-ads/media/big_buck_bunny_trailer.mp4";
    video.autoplay = true; video.muted = true; video.playsInline = true; video.controls = false;
    video.style.width = '100%'; video.style.height = '100%';
    container.innerHTML = ''; container.appendChild(video);
    try{ video.play().catch(()=>{}); }catch(e){}

    postParent({ type:'hosted_opened', payload: { ad_id } }); // additional helpful message

    // countdown
    let remaining = secs;
    const countEl = el('adCount'), claimBtn = el('claimBtn'), retBtn = el('retBtn'), adNote = el('adNote');
    if(countEl) countEl.textContent = remaining;
    if(adTimerInterval) clearInterval(adTimerInterval);
    adTimerInterval = setInterval(()=>{
      remaining--;
      if(countEl) countEl.textContent = remaining;
      if(remaining <= 0){
        clearInterval(adTimerInterval);
        if(claimBtn) claimBtn.disabled = false;
        adNote.textContent = 'Ad finished. Sending result...';

        const payload = {
          ad_id, reward, base: reward, vip_bonus: 0, vip_level, user_id: (user && user.user_id) || (profile && profile.user_id) || null,
          status: 'completed', meta: { ts: Date.now() }
        };

        // inform parent and also provide task_complete for compatibility
        postParent({ type:'ad_complete', payload });
        postParent({ type:'task_complete', payload });

        // Attempt webhook to bot if provided in authoritative payload (non-blocking)
        try{
          const wh = (auth && (auth.webhook || auth.callback || auth.hook || auth.url)) || null;
          if(wh){
            fetch(wh, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ action:'ads_validate', payload }), keepalive:true }).catch(()=>{});
          }
        }catch(e){}

        // cleanup authoritative payload
        try{ sessionStorage.removeItem(KEY_AUTH); }catch(e){}
        if(retBtn){ retBtn.classList.remove('hidden'); retBtn.textContent = 'Close'; }

        // Ask parent to close after short delay
        setTimeout(()=>{ postParent({ type:'close_hosted', reason:'ad_done', payload }); }, 900);
      }
    }, 1000);

    // claim button (manual)
    if(claimBtn) claimBtn.addEventListener('click', ()=>{
      if(claimBtn.disabled) return;
      claimBtn.disabled = true;
      const payload = { ad_id, reward, vip_level, user_id: (user && user.user_id) || (profile && profile.user_id) || null, status:'claimed', ts: Date.now() };
      postParent({ type:'ad_complete', payload });
      try{ sessionStorage.removeItem(KEY_AUTH); }catch(e){}
      if(retBtn){ retBtn.classList.remove('hidden'); retBtn.textContent = 'Close'; }
    });

    if(retBtn) retBtn.addEventListener('click', ()=> {
      postParent({ type:'close_hosted', reason:'user_return' });
      try{ if(window.close) window.close(); }catch(e){}
    });

  }catch(err){
    console.warn('renderAdFlow err', err);
    setMain('<div class="small">Unable to start ad view.</div>');
  }
}

/* ===== adsterra helpers (kept minimal) ===== */
function injectAdsterraInto(idOrElem){
  let holder = null;
  if(typeof idOrElem === 'string') holder = document.getElementById(idOrElem);
  else holder = idOrElem;
  if(!holder) return;
  holder.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.style.width = '468px'; wrap.style.maxWidth='100%'; wrap.style.height='60px'; wrap.style.margin='0 auto';
  const s1 = document.createElement('script'); s1.type='text/javascript';
  s1.text = "atOptions = { 'key' : 'a8702b8b4c48420a3815542007f1c0df', 'format' : 'iframe', 'height' : 60, 'width' : 468, 'params' : {} };";
  wrap.appendChild(s1);
  const s2 = document.createElement('script'); s2.type='text/javascript'; s2.src = "//www.highperformanceformat.com/a8702b8b4c48420a3815542007f1c0df/invoke.js";
  wrap.appendChild(s2);
  holder.appendChild(wrap);
}

/* ===== small helpers used earlier (kept minimal) ===== */
function clearStartPayload(){ try{ sessionStorage.removeItem(KEY_AUTH); sessionStorage.removeItem(KEY_PROFILE); profile=null; setVIPLabel(); }catch(e){} }
function getStoredAuth(){ try{ return JSON.parse(sessionStorage.getItem(KEY_AUTH)||'null'); }catch(e){ return null; } }
function addTaskDone(id){ try{ const k='gg_hosted_tasks_done'; const raw = localStorage.getItem(k)||'[]'; const arr = JSON.parse(raw); if(!arr.includes(id)) { arr.push(id); localStorage.setItem(k,JSON.stringify(arr)); } }catch(e){} }

/* ===== start router after DOM ready ===== */
if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', router);
else router();

/* expose helpers for debugging in console (kept) */
window.__hosted_clear = clearStartPayload;
window.__hosted_process = processStartPayload;

</script>
</body>
</html>